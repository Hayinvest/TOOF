<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TON Spin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 1px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: white;
    }
    .container {
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
    }
    h2 {
      font-size: 2em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    button {
      border: none;
      padding: 12px 25px;
      font-size: 15px;
      border-radius: 50px;
      margin: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      color: white;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    #payBtn {
      background: linear-gradient(45deg, #7c20ce, #5d0ba4);
    }
    
    #payBtn:hover:not(:disabled) {
      background: linear-gradient(45deg, #7c20ce, #5d0ba4);
      transform: translateY(-2px);
    }
    
    #spinBtn {
      background: linear-gradient(45deg, #7c20ce, #5d0ba4);
    }
    
    #spinBtn:hover:not(:disabled) {
      background: linear-gradient(45deg, #45057d, #31025a);
      transform: translateY(-2px);
    }
  
    button:disabled {
      background: linear-gradient(45deg, #666, #888);
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    #connect-root { 
      margin: 15px 50px;
    }
    
    #spinsLeft, #result, #userScore {
      font-size: 1.1em;
      margin: 15px 0;
      padding: 12px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .loading {
      display: none;
      margin: 10px 0;
      animation: pulse 1.5s infinite;
      padding: 12px;
      border-radius: 15px;
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .loading.show { 
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .wheel-container {
      position: relative;
      margin: 30px auto;
      width: 320px;
      height: 320px;
    }

    #pointer {
      position: absolute;
      top: -40px;
      left: 47%;
      transform: translateX(-50%);
      width: 0; 
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 30px solid #ff0000;
      z-index: 10;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
      animation: pointerGlow 2s infinite;
    }

    @keyframes pointerGlow {
      0%, 100% { filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
      50% { filter: drop-shadow(0 4px 15px rgba(204, 0, 0, 0.8)); }
    }

    #wheel {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      transition: transform 3s cubic-bezier(0.23, 1, 0.32, 1);
      box-shadow: 
        0 0 0 8px #7c20ce,
        0 0 0 12px rgba(249, 249, 249, 0.3),
        0 8px 30px rgba(0,0,0,0.4);
      background: conic-gradient(
        from 0deg,
        #FF6B6B 0deg 51.43deg,
        #4ECDC4 51.43deg 102.86deg,
        #45B7D1 102.86deg 154.29deg,
        #96CEB4 154.29deg 205.71deg,
        #FFEAA7 205.71deg 257.14deg,
        #DDA0DD 257.14deg 308.57deg,
        #98D8C8 308.57deg 360deg
      );
    }

    .sector {
      width: 50%;
      height: 50%;
      position: absolute;
      top: 50%; 
      left: 50%;
      transform-origin: 0% 0%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      border-left: 2px solid rgba(255,255,255,0.3);
    }

    .sector:nth-child(1) { transform: rotate(0deg) skewY(38.57deg); }
    .sector:nth-child(2) { transform: rotate(51.43deg) skewY(38.57deg); }
    .sector:nth-child(3) { transform: rotate(102.86deg) skewY(38.57deg); }
    .sector:nth-child(4) { transform: rotate(154.29deg) skewY(38.57deg); }
    .sector:nth-child(5) { transform: rotate(205.71deg) skewY(38.57deg); }
    .sector:nth-child(6) { transform: rotate(257.14deg) skewY(38.57deg); }
    .sector:nth-child(7) { transform: rotate(308.57deg) skewY(38.57deg); }

    /* Center circle */
    #wheel::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #7c20ce, #650eb2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 5;
    }

    /* Spinning animation */
    .spinning {
      animation: sparkle 0.5s infinite;
    }

    @keyframes sparkle {
      0%, 100% { box-shadow: 
        0 0 0 8px #7c20ce,
        0 0 0 12px rgba(163, 163, 159, 0.3),
        0 8px 30px rgba(0,0,0,0.4); }
      50% { box-shadow: 
        0 0 0 8px #7c20ce,
        0 0 0 12px rgba(234, 234, 234, 0.8),
        0 8px 30px rgba(159, 159, 159, 0.3),
        0 0 50px rgba(255, 255, 255, 0.5); }
    }

    /* Icon styling with colors */
    .fa-hourglass-half { color: #FFD700; } /* Gold for loading */
    .fa-ticket-alt { color: #0fbaee; } /* Teal for spins */
    .fa-star { color: #7c20ce; } /* Gold for score */
    .fa-sync-alt { color: white; } /* White for spin button */
    .fa-check-circle { color: #4CAF50; } /* Green for success */
    .fa-search-dollar { color: #2196F3; } /* Blue for processing */
    .fa-exclamation-circle { color: #2196F3; } /* Red for errors */
    .fa-trophy { color: #FFD700; } /* Gold for winning */
    .fa-spinner { color: #7c20ce; } /* Purple for spinning */
    .fa-bullseye { color: white; } /* White for wheel center */
    .fa-wallet { color: #0088cc; } /* Blue for TON wallet */

    /* Responsive design */
    @media (max-width: 480px) {
      .wheel-container {
        width: 280px;
        height: 280px;
      }
      #wheel {
        width: 260px;
        height: 260px;
      }
      .sector {
        font-size: 14px;
      }
    }

    /* TON icon in button */
    .ton-icon {
      width: 20px;
      height: 20px;
    }
    canvas {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
  background: linear-gradient(90deg, #8A2BE2, #191970);
  background-size: 200% 100%;

  animation: slide 6s ease-in-out infinite alternate;
}
@keyframes slide {
  0%   { background-position: left; }
  100% { background-position: right; }
}
  .back-btn {
      background: #8225d8;
      color: #ffffff;
      border: none;
      padding: 8px 10px;
      border-radius: 8px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.3s;
      position: absolute;
      top: 4%;
    }
  </style>
</head>
<body>

    <canvas id="starCanvas"></canvas>

  <div class="container">
    <div id="connect-root"></div>
        <a href="index.html">
        <button class="back-btn"><i class="fas fa-arrow-left"></i></button>
      </a>
    <button id="payBtn" disabled>
      <img src="https://raw.githubusercontent.com/haykoo707/hypervverse/refs/heads/main/toncoin-ton-logo.png" alt="TON" class="ton-icon">
      Pay 0.0000001 TON & Get Spin
    </button>
    <div class="loading" id="loading">
      <i class="fas fa-hourglass-half"></i> Processing payment...
    </div>

    <!-- Enhanced Spin Wheel -->
    <div class="wheel-container">
      <div id="pointer"></div>
      <div id="wheel"></div>
    </div>

    <button id="spinBtn" disabled>
      <i class="fas fa-sync-alt"></i> Spin the Wheel!
    </button>
    <div id="spinsLeft">
      <i class="fas fa-ticket-alt"></i> Spins left: 0
    </div>
    <div id="userScore">
      <i class="fas fa-star"></i> UserScore: 0
    </div>
    <div id="result"></div>
  </div>

  <script>
   // Replace the script section in your HTML with this updated version

const BACKEND_URL = "https://ton-check.onrender.com";
const RECEIVER = "UQCb8i7V_2QxUurP0ZCIHCVglCmKSeKjIzgHekP3XDondvbm";

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://haykoo707.github.io/test-payment/tonconnect-manifest.json",
  buttonRootId: "connect-root",
  uiPreferences: { theme: "SYSTEM" }
});

let spins = 0;
let userScore = parseInt(localStorage.getItem("userScore")) || 0;

const spinBtn = document.getElementById("spinBtn");
const spinsEl = document.getElementById("spinsLeft");
const scoreEl = document.getElementById("userScore");
const resultEl = document.getElementById("result");
const wheel = document.getElementById("wheel");
const loadingEl = document.getElementById("loading");

const rewards = [1000, 2000, 4000, 5000, 7500, 10000, 20000, 5000];

// Build wheel segments
function buildWheel() {
  const segmentAngle = 360 / rewards.length;
  rewards.forEach((reward, i) => {
    const segment = document.createElement("div");
    segment.className = "segment";
    segment.style.transform = `rotate(${i * segmentAngle}deg) skewY(${90 - segmentAngle}deg)`;
    segment.innerText = `+${reward}`;
    wheel.appendChild(segment);
  });
}
buildWheel();

function updateUI() {
  spinsEl.innerText = `Spins left: ${spins}`;
  scoreEl.innerText = `Score: ${userScore}`;
  spinBtn.disabled = spins <= 0;
}
updateUI();

function showLoading(show = true) {
  loadingEl.classList.toggle("show", show);
}

// Show result message
function showResult(message, isSuccess = true) {
  resultEl.innerText = message;
  resultEl.style.color = isSuccess ? '#4ade80' : '#f87171';
}

// Handle wallet connection
tonConnectUI.onStatusChange(wallet => {
  document.querySelectorAll(".pay-package").forEach(btn => {
    btn.disabled = !wallet;
  });
  updateUI();
});

// Verify payment with backend
async function verifyPayment(senderAddress, txHash = null) {
  try {
    const payload = { senderAddress };
    if (txHash) payload.txHash = txHash;

    console.log("Verifying payment:", payload);

    const response = await fetch(`${BACKEND_URL}/check-payment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`Server responded with status: ${response.status}`);
    }

    const result = await response.json();
    console.log("Payment verification result:", result);

    return result;
  } catch (error) {
    console.error("Payment verification error:", error);
    throw new Error(`Payment verification failed: ${error.message}`);
  }
}

// Payment packages
document.querySelectorAll(".pay-package").forEach(btn => {
  btn.addEventListener("click", async () => {
    const spinsToAdd = parseInt(btn.dataset.spins);
    const amount = btn.dataset.amount;
    
    // Disable button and show loading
    btn.disabled = true;
    showLoading(true);
    showResult("ðŸ’³ Initiating payment...", true);

    try {
      // Get current wallet
      const wallet = tonConnectUI.wallet;
      if (!wallet) {
        throw new Error("Wallet not connected");
      }

      const senderAddress = wallet.account.address;

      // Create transaction
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 600, // 10 minutes
        messages: [{
          address: RECEIVER,
          amount: amount.toString()
        }]
      };

      showResult("ðŸ“± Please confirm transaction in your wallet...", true);

      // Send transaction
      const sendResult = await tonConnectUI.sendTransaction(tx);
      if (!sendResult || !sendResult.boc) {
        throw new Error("Transaction was not sent or confirmed");
      }

      console.log("Transaction sent:", sendResult);
      showResult("â³ Transaction sent! Verifying payment...", true);

      // Wait for transaction to be processed and indexed
      await new Promise(resolve => setTimeout(resolve, 5000));

      // Verify payment with backend
      let verificationAttempts = 0;
      const maxAttempts = 6; // 6 attempts over ~30 seconds
      
      while (verificationAttempts < maxAttempts) {
        try {
          const verification = await verifyPayment(senderAddress);
          
          if (verification.success) {
            // Payment verified successfully
            spins += verification.spins;
            updateUI();
            showResult(`âœ… Payment verified! You received ${verification.spins} spins!`, true);
            console.log("Payment successful:", verification);
            return; // Exit successfully
          } else {
            console.log(`Verification attempt ${verificationAttempts + 1}: Payment not yet confirmed`);
          }
        } catch (verifyError) {
          console.log(`Verification attempt ${verificationAttempts + 1} failed:`, verifyError.message);
        }

        verificationAttempts++;
        
        if (verificationAttempts < maxAttempts) {
          showResult(`ðŸ” Verifying payment... (${verificationAttempts}/${maxAttempts})`, true);
          await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds between attempts
        }
      }

      // If we get here, verification failed after all attempts
      throw new Error("Payment verification timed out. Please check your transaction and try again.");

    } catch (err) {
      console.error("Payment error:", err);
      showResult(`âŒ Payment failed: ${err.message}`, false);
    } finally {
      // Re-enable button and hide loading
      btn.disabled = false;
      showLoading(false);
    }
  });
});

// Spin animation
spinBtn.addEventListener("click", () => {
  if (spins <= 0) return;
  
  // Disable spin button during animation
  spinBtn.disabled = true;
  spins--;
  updateUI();

  const segmentAngle = 360 / rewards.length;
  const winningIndex = Math.floor(Math.random() * rewards.length);
  const rotation = 360 * 5 + (360 - winningIndex * segmentAngle - segmentAngle/2);

  wheel.style.transition = "transform 4s cubic-bezier(0.17,0.67,0.83,0.67)";
  wheel.style.transform = `rotate(${rotation}deg)`;

  setTimeout(() => {
    const reward = rewards[winningIndex];
    userScore += reward;
    localStorage.setItem("userScore", userScore);
    updateUI();
    showResult(`ðŸŽ‰ You won +${reward} Score!`, true);
    
    // Re-enable spin button if there are spins left
    spinBtn.disabled = spins <= 0;
  }, 4200);
});

// Add some utility functions for debugging
window.debugFunctions = {
  checkWallet: () => tonConnectUI.wallet,
  checkSpins: () => spins,
  addTestSpins: (amount = 1) => {
    spins += amount;
    updateUI();
    console.log(`Added ${amount} test spins`);
  },
  resetScore: () => {
    userScore = 0;
    localStorage.setItem("userScore", "0");
    updateUI();
    console.log("Score reset to 0");
  }
};
  </script>
</body>

</html>
